#!/usr/bin/env sh

if [ $# -gt 2 ] || [ "${1}" = "-h" ]; then
	printf "usage: lem [-k] [<host>]\n"
	exit 1
fi

PG_CMD="pgrep --list-full --full"
PK_CMD="pkill --echo --full"

if [ "${1}" = "-k" ]; then
	KILL="true"
	shift
fi

HOST_REMOTE="${1}"

PORT_REMOTE=2489
PORT_LOCAL=2489

PAT_SERVER="lemonade server"
PAT_TUNNEL="${HOST_REMOTE}.*${PORT_REMOTE}:127.0.0.1:${PORT_LOCAL}"

# kill server
${PK_CMD} "${PAT_SERVER}"

# kill tunnel
${PK_CMD} "${PAT_TUNNEL}"

if [ "${KILL}" = "true" ]; then
	exit
fi

# start server
lemonade server --port=${PORT_LOCAL} --allow="127.0.0.1,::1" > /tmp/lem.log 2>&1 &
if ! ${PG_CMD} "${PAT_SERVER}"; then
	cat /tmp/lem.log
	exit 1
fi

# maybe start tunnel
if [ "${HOST_REMOTE}" ]; then
	ssh "${HOST_REMOTE}" -f -N -R "${PORT_REMOTE}:127.0.0.1:${PORT_LOCAL}"
	if ! ${PG_CMD} "${PAT_TUNNEL}"; then
		exit 1
	fi
fi

