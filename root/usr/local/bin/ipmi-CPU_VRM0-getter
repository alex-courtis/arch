#!/usr/bin/env sh

sdr="$(ipmicfg -sdr)"
RC=$?

if [ $RC -ne 0 ]; then
	# ipmicfg errors go to stdout
	echo "${sdr}" 1>&2
	exit $RC
fi

cap_deg_c="^\| +([0-9]+)C.*"

deg_c="$(echo "${sdr}" | \
	grep CPU_VRM | \
	cut -c 35-50 | \
	sed -E "/${cap_deg_c}/!{q1}; s//\1/g")"

RC=$?
if [ $RC -ne 0 ]; then
	# ipmicfg errors go to stdout
	echo "${sdr}" 1>&2
	exit $RC
fi

printf "%s" "${deg_c}" > /run/ipmi-CPU_VRM0
