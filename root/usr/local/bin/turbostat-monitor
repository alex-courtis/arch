#!/usr/bin/env sh

interval=5
failures_allowed=5
out="/run/turbostat-PkgWatt"

failures=0
while true; do
	stats=$(turbostat \
		--quiet \
		--cpu package \
		--Summary \
		--show PkgWatt \
		--num_iterations 1 \
		--interval "${interval}")
	RC=$?

	if [ $RC -ne 0 ]; then
		echo "${stats}" 1>&2
		echo "!!" > "${out}"
		if [ $(( ++ failures )) -ge $failures_allowed ]; then
			echo "terminating after ${failures_allowed} failures"
			exit 1
		fi
	else
		echo "${stats}" | \
			grep -v "PkgWatt" | \
			sed -E 's/\.[0-9]*$//g' \
			> "${out}"
	fi
done

